<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>楼市日历 - 升级版Tab底部</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
<style>
body { font-family: Arial, sans-serif; margin:0; background:#f7f7f7; padding-bottom:60px; }

/* 月份切换头部 */
header { background: #f2f6ff; padding: 15px; text-align:center; font-size:20px;}

#calendar-container { max-width: 420px; margin:auto; }
#calendar { width:100%; background:white; border-radius:8px; padding:10px;}
#calendar table { width:100%; border-collapse: collapse; text-align:center;}
#calendar th, #calendar td { padding:6px;}
#calendar td { height:50px; vertical-align:top;}
.green { color: green; }
.blue { color: white; background:#1990ff; border-radius:8px; }
.nav-btn { cursor:pointer; margin:0 10px; color:#1990ff; user-select:none;}
.day-num { font-weight:bold; font-size:14px; }
.day-val { font-size:12px; margin-top:4px; }
.total-month { text-align:right; margin: 5px 0; font-weight:bold; color:#333; }

#chart-container { max-width:420px; margin:15px auto; background:white; border-radius:8px; padding:10px;}
#chart { width:100%; height:300px; }

/* 底部固定Tab导航 */
.tab-nav {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    max-width: 420px;
    width: 100%;
    display: flex;
    background: #fff;
    border-top: 2px solid #1990ff;
    border-radius:8px 8px 0 0;
    overflow:hidden;
    box-shadow:0 -2px 5px rgba(0,0,0,0.1);
}
.tab-nav div {
    flex:1;
    padding:12px;
    text-align:center;
    cursor:pointer;
    font-weight:bold;
    background:#f5faff;
    color:#1990ff;
    transition: 0.3s;
}
.tab-nav .active {
    background:#1990ff;
    color:white;
}
.week-sum .day-num {
    font-weight:bold;
    font-size:14px;
    color:#333; /* 你可以改成和日期数字一样的绿色或蓝色 */
}

</style>
</head>
<body>

<!-- 月份切换 -->
<header>
  <span class="nav-btn" onclick="prevMonth()">◀</span>
  <span id="monthTitle"></span>
  <span class="nav-btn" onclick="nextMonth()">▶</span>
</header>

<!-- 日历部分 -->
<div id="calendar-container">
    <div class="total-month" id="monthTotal"></div>
    <div id="calendar"></div>
</div>

<!-- 图表部分 -->
<div id="chart-container">
    <div id="chart"></div>
</div>

<!-- 底部Tab导航 -->
<div class="tab-nav">
    <div id="tab-old" class="active" onclick="switchTab('old')">二手房</div>
    <div id="tab-new" onclick="switchTab('new')">新房</div>
</div>

<script>
let excelData = [];
let currentDate = new Date(2025, 8, 1); // 默认显示9月
let currentType = 'old'; // 默认二手房

function switchTab(type) {
    currentType = type;
    document.getElementById('tab-old').classList.toggle('active', type === 'old');
    document.getElementById('tab-new').classList.toggle('active', type === 'new');
    loadExcel();
}

function loadExcel() {
    const fileName = currentType === 'old' ? 'oldhousedata.xlsx' : 'newhousedata.xlsx';
    fetch(fileName).then(res => {
        if (!res.ok) throw new Error(`找不到 ${fileName}`);
        return res.arrayBuffer();
    }).then(data => {
        const workbook = XLSX.read(data, {type:'array'});
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet);

        excelData = json.map(row => {
            let rawDate = row.date || row.data || row.日期;
            let rawValue = row.value || row.成交套数 || row.套数;
            let dateObj = parseExcelDate(rawDate);
            return { date: dateObj, value: Number(rawValue) };
        });

        renderCalendar();
        renderChart();
    }).catch(err => {
        console.warn('读取 Excel 出错:', err);
        excelData = [];
        renderCalendar();
        renderChart();
    });
}

function parseExcelDate(val) {
    if (val instanceof Date) return val;
    if (typeof val === 'number') {
        let d = XLSX.SSF.parse_date_code(val);
        return new Date(d.y, d.m - 1, d.d);
    }
    if (typeof val === 'string') {
        let clean = val.replace(/[年月]/g, '-').replace(/日/, '').replace(/\//g,'-').trim();
        let parts = clean.split('-');
        if (parts.length >= 3 && parts[0].length === 4) {
            return new Date(parts[0], parts[1] - 1, parts[2]);
        }
        return new Date(clean);
    }
    return new Date(val);
}

function sameDay(d1, d2) {
    return d1.getFullYear() === d2.getFullYear() &&
           d1.getMonth() === d2.getMonth() &&
           d1.getDate() === d2.getDate();
}

// 渲染日历
function renderCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month+1, 0);

    document.getElementById('monthTitle').innerText = `${year}年${month+1}月`;

    let monthTotal = 0;
    let html = "<table><tr><th>一</th><th>二</th><th>三</th><th>四</th><th>五</th><th>六</th><th>日</th><th>周合计</th></tr><tr>";

    let dayOfWeek = (firstDay.getDay() || 7);
    let weekSum = 0;

    for (let i=1; i<dayOfWeek; i++) {
        html += "<td></td>";
    }

for (let d=1; d<=lastDay.getDate(); d++) {
    const dateObj = new Date(year, month, d);
    const record = excelData.find(r => sameDay(r.date, dateObj));
    let val = record ? record.value : null;
    monthTotal += val || 0;
    weekSum += val || 0;

    let cls = '';
    if (val != null) {
        if (val >= 800) cls = 'blue';
        else cls = 'green';
    }
    html += `<td class="${cls}">
                <div class="day-num">${d}</div>
                ${val ? `<div class="day-val">${val}</div>` : ''}
             </td>`;

    // 如果是周日或最后一天
    if ((dayOfWeek + d -1)%7===0 || d === lastDay.getDate()) {

        // 检查最后一周是否需要补齐空格
        if (d === lastDay.getDate() && (dayOfWeek + d -1)%7 !== 0) {
            let remaining = 7 - ((dayOfWeek + d -1) % 7);
            for (let i=0; i<remaining; i++) {
                html += `<td></td>`;
            }
        }

        // 周合计单元格
        html += `<td class="week-sum"><div class="day-num">${weekSum}</div></td></tr>`;
        
        if (d !== lastDay.getDate()) html += "<tr>";
        weekSum = 0;
    }
}


    html += "</table>";

    document.getElementById('calendar').innerHTML = html;
    document.getElementById('monthTotal').innerText = `本月累计成交量：${monthTotal}`;
}

// 渲染图表
function renderChart() {
    let chart = echarts.init(document.getElementById('chart'));
    let grouped = {};
    excelData.forEach(r => {
        let key = `${r.date.getFullYear()}-${(r.date.getMonth()+1).toString().padStart(2,'0')}`;
        grouped[key] = (grouped[key]||0) + r.value;
    });
    let months = Object.keys(grouped).sort();
    let values = months.map(m => grouped[m]);

    // 环比涨幅（相邻月份增长率）
    let momRates = values.map((v, i) => i === 0 ? 0 : (((v - values[i-1]) / values[i-1]) * 100).toFixed(1));

    let option = {
        title:{text:(currentType==='old' ? '二手房' : '新房')+' 月成交走势', left:'center'},
        tooltip:{trigger:'axis'},
        legend:{data:['成交量','环比涨幅'], top:25},
        grid: { left: '5%', right: '5%', containLabel: true },
        xAxis:{type:'category', data:months},
        yAxis:[
            { type:'value', name:'成交量' },
            { type:'value', name:'环比(%)', axisLabel:{ formatter:'{value} %' } }
        ],
        series:[
            {
                name:'成交量',
                type:'bar',
                data:values,
                itemStyle:{color:'#4b8bf4'}
            },
            {
                name:'环比涨幅',
                type:'line',
                yAxisIndex:1,
                data:momRates,
                itemStyle:{color:'#ff9900'},
                smooth:true
            }
        ]
    };
    chart.setOption(option);
}

function prevMonth(){
    currentDate.setMonth(currentDate.getMonth()-1);
    renderCalendar();
}
function nextMonth(){
    currentDate.setMonth(currentDate.getMonth()+1);
    renderCalendar();
}

loadExcel();
</script>

</body>
</html>
