<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>楼市日历 - 多sheet支持</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
<style>
body { font-family: Arial, sans-serif; margin:0; background:#f7f7f7; padding-bottom:60px; }
header { background: #f2f6ff; padding: 15px; text-align:center; font-size:20px;}
#calendar { width:100%; background:white; border-radius:8px; padding:10px;}
#calendar table { width:100%; border-collapse: collapse; text-align:center;}
#calendar th, #calendar td { padding:6px;}
#calendar td { height:50px; vertical-align:top;}
.nav-btn { cursor:pointer; margin:0 10px; color:#1990ff; user-select:none;}
.day-num { font-weight:bold; font-size:14px; }
.day-val { font-size:12px; margin-top:4px; color: green; font-weight:bold; } /* 成交量绿色 */
.total-month { text-align:right; margin: 5px 0; font-weight:bold; color:#333; }
.today-circle {
    display: inline-block;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background-color: blue;
    color: white;
    font-size: 13px;
    line-height: 22px;
}
#chart-container { background:white; border-radius:8px; padding:10px; margin-top:15px;}
#chart { width:100%; height:300px; }
.tab-nav {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    background: #fff;
    border-top: 2px solid #1990ff;
    border-radius:8px 8px 0 0;
    overflow:hidden;
    box-shadow:0 -2px 5px rgba(0,0,0,0.1);
    display: flex;
}
.tab-nav div {
    flex:1;
    padding:12px;
    text-align:center;
    cursor:pointer;
    font-weight:bold;
    background:#f5faff;
    color:#1990ff;
    transition: 0.3s;
}
.tab-nav .active { background:#1990ff; color:white; }
.week-sum .day-num,
.week-sum .day-val { font-size:12px; margin-top:4px; color: green; font-weight:bold; }

/* PC端保持420px居中 */
@media screen and (min-width: 769px) {
    #calendar-container,
    #chart-container,
    .tab-nav {
        max-width: 420px;
        width: 100%;
        margin: auto;
    }
}

/* 手机端全屏 + 高度增加 + 字体变大 */
@media screen and (max-width: 768px) {
    #calendar-container,
    #chart-container,
    .tab-nav {
        width: 100%;
        max-width: none;
        margin: 0;
        left: 0;
        transform: none;
    }
    /* 日历单元格高度增加 */
    #calendar td {
        height: 70px; /* 原50px */
    }
    /* 日期数字更大 */
    .day-num {
        font-size: 18px;  /* 原14px */
    }
    /* 成交量数字更大 */
    .day-val {
        font-size: 14px; /* 原12px */
    }
    /* 周合计数字字号同步放大 */
    .week-sum .day-num,
    .week-sum .day-val {
        font-size: 14px;
    }
    /* 图表区域间距增加 */
    #chart-container {
        padding: 15px;
    }
    /* 底部导航按钮更高、更大字体 */
    .tab-nav div {
        padding: 16px;
        font-size: 16px;
    }
}
</style>
</head>
<body>

<header>
  <span class="nav-btn" onclick="prevMonth()">◀</span>
  <span id="monthTitle"></span>
  <span class="nav-btn" onclick="nextMonth()">▶</span>
</header>

<div id="calendar-container">
    <div class="total-month" id="monthTotal"></div>
    <div id="calendar"></div>
</div>

<div id="chart-container">
    <div id="chart"></div>
</div>

<div class="tab-nav">
    <div id="tab-old" class="active" onclick="switchTab('old')">二手房</div>
    <div id="tab-new" onclick="switchTab('new')">新房</div>
</div>

<script>
let allMonthsData = {};
let monthKeys = [];
let currentMonthKey = '';
let currentType = 'old';

function switchTab(type) {
    currentType = type;
    document.getElementById('tab-old').classList.toggle('active', type === 'old');
    document.getElementById('tab-new').classList.toggle('active', type === 'new');
    loadExcel();
}

function loadExcel() {
    const fileName = currentType === 'old' ? 'oldhousedata.xlsx' : 'newhousedata.xlsx';
    const url = `${fileName}?v=${Date.now()}`; // 防缓存
    fetch(url)
    .then(res => {
        if (!res.ok) throw new Error(`找不到 ${fileName}`);
        return res.arrayBuffer();
    })
    .then(data => {
        const workbook = XLSX.read(data, {type:'array'});
        allMonthsData = {};
        monthKeys = [];

        workbook.SheetNames.forEach(name => {
            const sheet = workbook.Sheets[name];
            const json = XLSX.utils.sheet_to_json(sheet);
            const parsed = json.map(row => {
                let rawDate = row.date || row.data || row.日期;
                let rawValue = row.value || row.成交套数 || row.套数;
                return { date: parseExcelDate(rawDate), value: Number(rawValue) };
            });
            allMonthsData[name] = parsed;
            monthKeys.push(name);
        });

        monthKeys.sort();
        const now = new Date();
        const nowKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
        currentMonthKey = monthKeys.includes(nowKey) ? nowKey : monthKeys[0];

        renderCalendar();
        renderChart();
    })
    .catch(err => {
        console.warn('读取 Excel 出错:', err);
        allMonthsData = {};
        monthKeys = [];
        renderCalendar();
        renderChart();
    });
}

function parseExcelDate(val) {
    if (val instanceof Date) return val;
    if (typeof val === 'number') {
        let d = XLSX.SSF.parse_date_code(val);
        return new Date(d.y, d.m - 1, d.d);
    }
    if (typeof val === 'string') {
        let clean = val.replace(/[年月]/g, '-').replace(/日/, '').replace(/\//g,'-').trim();
        let parts = clean.split('-');
        if (parts.length >= 3 && parts[0].length === 4) {
            return new Date(parts[0], parts[1] - 1, parts[2]);
        }
        return new Date(clean);
    }
    return new Date(val);
}

function sameDay(d1, d2) {
    return d1.getFullYear() === d2.getFullYear() &&
           d1.getMonth() === d2.getMonth() &&
           d1.getDate() === d2.getDate();
}

function renderCalendar() {
    const data = allMonthsData[currentMonthKey] || [];
    const [year, month] = currentMonthKey.split('-').map(Number);
    const firstDay = new Date(year, month-1, 1);
    const lastDay = new Date(year, month, 0);
    document.getElementById('monthTitle').innerText = `${year}年${month}月`;

    let monthTotal = 0;
    let html = "<table><tr><th>一</th><th>二</th><th>三</th><th>四</th><th>五</th><th>六</th><th>日</th><th>周合计</th></tr><tr>";

    let dayOfWeek = (firstDay.getDay() || 7);
    let weekSum = 0;
    const today = new Date();

    for (let i=1; i<dayOfWeek; i++) html += "<td></td>";

    for (let d=1; d<=lastDay.getDate(); d++) {
        const dateObj = new Date(year, month-1, d);
        const record = data.find(r => sameDay(r.date, dateObj));
        let val = record ? record.value : null;
        monthTotal += val || 0;
        weekSum += val || 0;

        let dayDisplay;
        if (sameDay(dateObj, today)) {
            dayDisplay = `<span class="today-circle">${d}</span>`;
        } else {
            dayDisplay = `${d}`;
        }

        html += `<td>
                    <div class="day-num">${dayDisplay}</div>
                    ${val ? `<div class="day-val">${val}</div>` : ''}
                 </td>`;

        if ((dayOfWeek + d -1)%7===0 || d === lastDay.getDate()) {
            if (d === lastDay.getDate() && (dayOfWeek + d -1)%7 !== 0) {
                let rem = 7 - ((dayOfWeek + d -1) % 7);
                for (let i=0; i<rem; i++) html += `<td></td>`;
            }
            html += `<td class="week-sum"><div class="day-val">${weekSum}</div></td></tr>`; 
            if (d !== lastDay.getDate()) html += "<tr>";
            weekSum = 0;
        }
    }

    html += "</table>";
    document.getElementById('calendar').innerHTML = html;
    document.getElementById('monthTotal').innerText = `本月累计成交量：${monthTotal}`;
}

function renderChart() {
    let chart = echarts.init(document.getElementById('chart'));

    let grouped = {};
    Object.keys(allMonthsData).forEach(key => {
        grouped[key] = allMonthsData[key].reduce((sum, r) => sum + r.value, 0);
    });

    let months = Object.keys(grouped).sort();
    let values = months.map(m => grouped[m]);
    let momRates = values.map((v, i) => i === 0 ? 0 : (((v - values[i-1]) / values[i-1]) * 100).toFixed(1));

    let option = {
        title:{text:(currentType==='old' ? '二手房' : '新房')+' 月成交走势', left:'center'},
        tooltip:{trigger:'axis'},
        legend:{data:['成交量','环比涨幅'], top:25},
        grid: { left: '5%', right: '5%', containLabel: true },
        xAxis:{type:'category', data:months},
        yAxis:[
            { type:'value', name:'成交量' },
            { type:'value', name:'环比(%)', axisLabel:{ formatter:'{value} %' } }
        ],
        series:[
            { name:'成交量', type:'bar', data:values, itemStyle:{color:'#4b8bf4'} },
            { name:'环比涨幅', type:'line', yAxisIndex:1, data:momRates, itemStyle:{color:'#ff9900'}, smooth:true }
        ]
    };
    chart.setOption(option);
}

function prevMonth(){
    let idx = monthKeys.indexOf(currentMonthKey);
    if (idx > 0) { currentMonthKey = monthKeys[idx-1]; renderCalendar(); renderChart(); }
}
function nextMonth(){
    let idx = monthKeys.indexOf(currentMonthKey);
    if (idx < monthKeys.length - 1) { currentMonthKey = monthKeys[idx+1]; renderCalendar(); renderChart(); }
}

loadExcel();
</script>
</body>
</html>
